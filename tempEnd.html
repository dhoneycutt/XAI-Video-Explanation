<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>ALT</title>
</head>
<body>
    <link rel="stylesheet" href="styles.css" />

    <p class="centerP">
        Thank you for your participation. Please send the downloaded file to the researcher.
    </p>
    <br />
    <script src="boxes.js"></script>

</body>
</html>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
  var today = new Date();
  localStorage.taskEnd = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();

  // Setup the video name/ID setup
  if (localStorage.groupCond == "1") {
    videoList = ["s13-d21.mp4", "s13-d23.mp4", "s13-d27.mp4", "s13-d45.mp4", "s14-d27.mp4", "s37-d46.mp4", "s32-d27.mp4"]
    videoNumbers = [13, 5, 3, 4, 4, 7, 2]
  }
  else if (localStorage.groupCond == "2") {
    videoList = ["s14-d29.mp4", "s14-d43.mp4", "s15-d23.mp4", "s14-d51.mp4", "s15-d46.mp4", "s24-d29.mp4", "s24-d21.mp4", "s25-d51.mp4"]
    videoNumbers = [11, 7, 5, 4, 5, 1, 2, 1]
  }
  else if (localStorage.groupCond == "3") {
    videoList = ["s21-d23.mp4", "s21-d43.mp4", "s28-d51.mp4", "s29-d29.mp4", "s33-d45.mp4", "s34-d21.mp4", "s36-d23.mp4", "s36.d43.mp4"]
    videoNumbers = [1, 4, 1, 2, 4, 6, 3, 14]
  }
  else if (localStorage.groupCond == "4") {
    videoList = ["s13-d23.mp4", "s13-d27.mp4"]
    videoNumbers = [2, 3]
  }
  else {
    videoList = ["s13-d21.mp4", "s13-d23.mp4", "s13-d27.mp4", "s13-d45.mp4", "s14-d27.mp4", "s37-d46.mp4", "s32-d27.mp4"]
    videoNumbers = [13, 5, 3, 4, 4, 7, 2]
  }

  // Parse expFeedback into usable stuff
  expString = localStorage.expFeedback
  expSplitOnSegment = expString.split(",|")
  console.log(expSplitOnSegment)
  // At this point there's an array with the lists separated by commas
  // Last array element is empty string
  // Strings may have extra comma at start or end of string

  // Remove end element
  expSplitOnSegment.pop()

  questionIdCount = 1
  currentVideo = 0
  var expActivities = []
  for (i = 0; i < expSplitOnSegment.length; i++){
    // Remove start comma
    if (expSplitOnSegment[i].charAt(0) == ",") {
      expSplitOnSegment[i] = expSplitOnSegment[i].slice(1);
    };

    // Remove end comma
    if (expSplitOnSegment[i].charAt(expSplitOnSegment[i].length) == ",") {
      expSplitOnSegment[i] = expSplitOnSegment[i].slice(0, -1);
    };

    // Split into activities:
    activities = expSplitOnSegment[i].split(",");
    console.log(activities);

    // Convert activity strings into activity objects
    var orderedActivities = []
    for (j = 0; j < activities.length; j++){
      components = activities[j].split(" + ")

      // Convert to "n/a"
      if (components[0] == "any action") { components[0] = "n/a" }
      if (components[1] == "any object") { components[1] = "n/a" }
      if (components[2] == "any location") { components[2] = "n/a" }

      // Add components to object
      var textExplanations = {}
      textExplanations.approximation = j+1
      textExplanations.object = components[0]
      textExplanations.activity = components[1]
      textExplanations.location = components[2]

      // Push to segment list
      orderedActivities.push(textExplanations)
    }
    // Push to segment list
    withID = {}
    // If there are still segments left in the video
    if (questionIdCount <= videoNumbers[currentVideo]) {
      withID.questionId = questionIdCount
      withID.videoName = videoList[currentVideo]
      questionIdCount = questionIdCount + 1
    }
    // If not, go to next video
    else {
      currentVideo = currentVideo + 1
      questionIdCount = 1
      withID.questionId = questionIdCount
      withID.videoName = videoList[currentVideo]
      questionIdCount = questionIdCount + 1
    }
    // withID.questionId = "id"
    // withID.videoName = "name"
    withID.textExplanations = orderedActivities
    expActivities.push(withID)
  }

  // Now expActivities has arrays of the feedback activities for each segment



  var output = {}
  output.id = localStorage.id
  output.condition = localStorage.groupCond
  output.expFeedback = expActivities
  output.ansFeedback = localStorage.ansFeedback.split(",")
  output.evalFeedback = localStorage.evalFeedback.split(",")
  output.startFeedback = localStorage.startFeedback.split(",")
  output.endFeedback = localStorage.endFeedback.split(",")
  output.userDiff = localStorage.userDiff.split(",")
  output.taskStart = localStorage.taskStart
  output.taskEnd = localStorage.taskEnd
  output.bgQ = JSON.parse(localStorage.bgQ)

  // output.preQ = {}
  // output.postQ = {}
  // output.time = {}
  //
  //
  // output.preQ.age = localStorage.age
  // output.preQ.CVWeakness = localStorage.CVWeakness
  // output.preQ.education = localStorage.education
  // output.from = localStorage.from
  // output.postQ.comments = localStorage.comments
  // output.postQ.changesS = localStorage.changesS
  // output.postQ.weak = localStorage.weak
  // output.postQ.changes = localStorage.changes
  // output.time.end = localStorage.endTime
  // output.preQ.gender = localStorage.gender
  // output.intCond = localStorage.intCond
  // output.midQs = localStorage.midQs
  // output.preQ.MLExp = localStorage.MLExp
  // output.ordCond = localStorage.ordCond
  // output.pAns = localStorage.pAns
  // output.time.start = localStorage.startTime
  // output.time.firstE = localStorage.time0
  // output.time.secondE = localStorage.time1
  // output.time.thirdE = localStorage.time2
  // output.time.firstS = localStorage.timeStart0
  // output.time.secondS = localStorage.timeStart1
  // output.time.thirdS = localStorage.timeStart2
  // output.time.tutBegin = localStorage.tutBegin
  // output.time.finalEnd = localStorage.finalEnd
  // output.trust1 = localStorage.trust1
  // output.trust2 = localStorage.trust2
  // output.trust3 = localStorage.trust3
  // output.trustUses = localStorage.trustUses

  // IDBox = document.getElementById("output")
  // IDBox.value = JSON.stringify(output)
  //Convert JSON string to BLOB.
  json = JSON.stringify(output)
  json = [json];
  var blob1 = new Blob(json, { type: "text/plain;charset=utf-8" });

  //Check the Browser.
  var isIE = false || !!document.documentMode;
  if (isIE) {
      window.navigator.msSaveBlob(blob1, "Customers.txt");
  } else {
      var url = window.URL || window.webkitURL;
      link = url.createObjectURL(blob1);
      var a = document.createElement("a");
      a.download = output.id + ".json";
      a.href = link;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
  }

  $.ajax({
    type : "POST",
    url : "json.php",
    data : {
        json : JSON.stringify(output)
    }
  });

  function copy() {
    // IDBox.select()
    document.execCommand('copy')
  }

  //continueBtn.style.background = "#A9A9A9";

  //Handle sliders
  //var slider1 = document.getElementById("q1");
  //slider1.value = 50
  //var output1 = document.getElementById("q1Val");
  //output1.innerHTML = "??"; // Display the default slider value

  // Update the current slider value (each time you drag the slider handle)
  //slider1.onclick = function() {
  //  output1.innerHTML = this.value;
  //  slider1.className = "sliderA"
  //  continueBtn.style.background = "#4CAF50"
  //  answered = 1
  //}


  //Setup timer to simulate the system implementing the responses
  //implementing = false
  //if(parseInt(localStorage.intCond) > 0) {
  //  implementing = true
  //  setTimeout(delayContinue, 60000)  //1 minute delay

  //  //Setup rotating gear icon
  //  i = 1;
  //  setInterval(turnGear, 500)
  //}
  //else {
  //  document.getElementById("gear").style.display = "none"
  //}
  //Questionnaire completion check
  const isComplete = (currentValue) => currentValue == 1


  function submit() {
    weak = document.getElementById("weak").value
    comments = document.getElementById("comments").value
    answered = 1

    if (weak == "") {
        answered = 0
    }
    if (comments == "") {
        answered = 0
    }
    if (answered == 0) {
      alert("You must answer all questions before continuing")
    }
    else {
        localStorage.weak = JSON.stringify(weak)
        localStorage.comments = JSON.stringify(comments)
        complete()
        //window.location.href = "binaryInteraction.html"

    }
  }

  function complete() {
    //TODO: Output values to json file

    //TODO: Move to final page (what to put here for AMT/SONA I don't know)

    alert("Done")
  }

</script>
